---
title: "analysis"
author: "Antoine"
date: \`r format(Sys.Date(), "%m %d,%Y")`\
output:
  slidy_presentation: default
---

```{r setup, include=FALSE}
rm(list=ls())

# packages
library(tidyverse)
library(DescTools)

# options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.height = 6, fig.width = 13, fig.align = "center")
```

```{r loading control}
# data_path.control <- "data/exp-control"
# 
# filename.control.dyn <- list.files(data_path.control, pattern="^[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt")
# 
# column.names.control.dyn <- c(
#   # init.params
#   "infection.rate",
#   "proportion",
#   "agregation",
#   "proba.overwintering",
#   "init.nb.adults",
#   "proba.birth",
#   # time
#   "year",
#   "tick",
#   # outputs
#   "visit.count",
#   "dyn.inf",
#   "dyn.inf.non.occ",
#   "dyn.inf.occ",
#   "dyn.adults",
#   "tot.inf.cur",
#   "dyn.curation")
# 
# control.dyn <- tibble(filename.control.dyn) %>% 
#   # load whole data
#   mutate(file_contents = map(filename.control.dyn, ~ read_delim(file.path(data_path.control, .), delim = " ", col_names = column.names.control.dyn))) %>% 
#   unnest()
# 
# filename.control.totals <- list.files(data_path.control, pattern="^totals-[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt")
# 
# column.names.control.totals <- c(
#   # par.
#   "infection.rate",
#   "proportion",
#   "agregation",
#   # time
#   "year",
#   # outputs
#   "crop.loss.1st",
#   "crop.loss",
#   "crop.save")
# 
# control.totals <- tibble(filename.control.totals) %>% 
#   # load whole data
#   mutate(file_contents = map(filename.control.totals, ~ read_delim(file.path(data_path.control, .), delim = " ", col_names = column.names.control.totals))) %>% 
#   unnest()
```

```{r loading data}

## wd
# data_path <- "data/exp8"

data_path <- "data/essai-time-for-crop-loss4"


## dyn
filename.dyn <- list.files(data_path, 
                       pattern="^[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt")

column.names.dyn <- c(
  # init.params
  "infection.rate",
  "proportion",
  "agregation",
  "proba.overwintering",
  "nb.init",
  "proba.birth",
  # time
  "year",
  "tick",
  # outputs
  "visit.count",
  "dyn.inf",
  "dyn.inf.non.occ",
  "dyn.inf.occ",
  "dyn.adults",
  "tot.inf.cur",
  "dyn.curation")

data.dyn <- tibble(filename.dyn) %>% 
  # load whole data
  mutate(file_contents = map(filename.dyn, ~ read_delim(file.path(data_path, .), delim = " ", col_names = column.names.dyn))) %>% 
  unnest()

## totals
filename.totals <- list.files(data_path, 
                              pattern="^totals-[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt")

column.names.totals <- c(
  # par.
  "infection.rate",
  "proportion",
  "agregation",
  # time
  "year",
  # outputs
  "crop.loss.1st",
  "crop.loss",
  "crop.save")

data.totals <- tibble(filename.totals) %>% 
  # load whole data
  mutate(file_contents = map(filename.totals, ~ read_delim(file.path(data_path, .), delim = " ", col_names = column.names.totals))) %>% 
  unnest()

## distribution
filename.arrivals <- list.files(data_path,
                             pattern="^distribution-arrival-[0-9]{1,2}-[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt") 

column.names.arrivals <- c(
  # par.
  "proportion",
  "agregation", 
  "infection.rate",
  "nb.init",
  # time
  "year", 
  "tick", 
  # outputs
  "event",
  "pxcor",
  "pycor",
  "t.pest.alone",
  "tforcroploss")

data.arrivals <- tibble(filename.arrivals) %>% 
  mutate(file_contents = map(filename.arrivals, ~ read_delim(file.path(data_path, .), delim = " ", col_names = column.names.arrivals))) %>% 
  unnest()

## spatial
filename.spatial <- list.files(data_path,
                                pattern="^map-service-indicator-[0-9]{1,2}-[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt") 

column.names.spatial <- c(
  # par.
  "proportion",
  "agregation", 
  "infection.rate",
  # time
  "year", 
  "tick", 
  # outputs
  "pxcor",
  "pycor",
  "land.cover",
  "visit.counter",
  "nb.cycles",
  "crop.loss",
  "crop.save")

data.spatial <- tibble(filename.spatial) %>% 
  mutate(file_contents = map(filename.spatial, ~ read_delim(file.path(data_path, .), delim = " ", col_names = column.names.spatial))) %>% 
  unnest()
```

## Experiment

- faible taux d'infection : infection tous les 3 ticks
- 1 seul cycle infection - guérison possible par année (pas de 2nde infection)


## Dynamics for control

```{r dynamics.control}
# scenarios LA / SA
# dynamics of infection -> fill.level (total) and fill.level.non.occ (normally = fill.level because it's a control)

## scenario LA
control.dyn <- data.dyn %>% 
  filter(nb.init == 0)
  
control.dyn %>% 
  # select var.
  select(- filename.dyn, - proba.birth, -proba.overwintering, - nb.init, - visit.count, - tot.inf.cur, - dyn.curation) %>%
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # compute tick -> full landscape without pest control
  mutate(tick.full.th = ceiling(stock.crops/infection.rate)) %>% 
  # infection fill level in the landscape 
  mutate(fill.level = dyn.inf*100/stock.crops) %>% 
  # infected patches without predators (= control) in % (fill.level)
  mutate(fill.level.non.occ = dyn.inf.non.occ*100/stock.crops) %>%  
  # filter
  filter(agregation == 1) %>%
  filter(infection.rate %in% c(20)) %>% 
  filter(proportion %in% c(0,10,90)) %>%
  filter(year == 5) %>%
  filter(tick %in% seq(720, 869, 1)) %>% 
  #filter(tick %in% seq(1620, 1769, 1)) %>% 
  # plot
  ggplot() +
  # geom_point(aes(x = tick, y = dyn.inf, colour = "dyn.inf")) +
  geom_point(aes(x = tick, y = fill.level, colour = "fill.level"), 
             size = 1) +
  geom_point(aes(x = tick, y = fill.level, colour = "fill.level.non.occ"),
             size = 0.5) +
  # facets
  facet_grid(proportion ~ infection.rate, labeller = label_both) + 
  ggtitle("LA, y10 : Dynamics for control (% of infected crop patches & infected without predators)")

## scenario SA
control.dyn %>% 
  # select var.
  select(- filename.control.dyn, - proba.birth, -proba.overwintering, - init.nb.adults, - visit.count, - tot.inf.cur, - dyn.curation) %>%
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # compute tick -> full landscape without pest control
  mutate(tick.full.th = ceiling(stock.crops/infection.rate)) %>% 
  # infection fill level in the landscape 
  mutate(fill.level = dyn.inf*100/stock.crops) %>% 
  # infected patches without predators (= control) in % (fill.level)
  mutate(fill.level.non.occ = dyn.inf.non.occ*100/stock.crops) %>%  
  # filter
  filter(agregation == 5) %>%
  filter(infection.rate %in% c(1,5,7,10,15,20)) %>% 
  filter(proportion %in% c(1,30,50,70,90)) %>%
  filter(year == 10) %>%
  filter(tick %in% seq(1620, 1769, 1)) %>% 
  # plot
  ggplot() +
  # geom_point(aes(x = tick, y = dyn.inf, colour = "dyn.inf")) +
  geom_point(aes(x = tick, y = fill.level, colour = "fill.level"), 
             size = 1) +
  geom_point(aes(x = tick, y = fill.level, colour = "fill.level.non.occ"),
             size = 0.5) +
  # facets
  facet_grid(proportion ~ infection.rate, labeller = label_both) + 
  ggtitle("SA, y10 : Dynamics for control (% of infected crop patches & infected without predators)")
```

## Dynamics for data

```{r dynamics.data}
# data.dyn -> compute fill.levels (inf., inf.non.occ, inf.occ)
# data.dyn -> compute values.for.vline -> th. tick for full landscape (inf.)
# data.totals -> compute norm.crop.loss
# ggplot for scenarios LA / SA

data.dyn2 <- data.dyn %>% 
  # select data we are interested in
  select(- filename.dyn, - proba.birth, -proba.overwintering, - init.nb.adults, - visit.count, - tot.inf.cur, - dyn.curation) %>%   
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # tick = full landscape without pest control
  mutate(tick.full.th = ceiling(stock.crops/infection.rate)) %>% 
  # total infection fill level in the landscape 
  mutate(fill.level = dyn.inf*100/stock.crops) %>%
  # % of landscape infected patches without predators (adults / juveniles)
  mutate(fill.level.non.occ = dyn.inf.non.occ*100/stock.crops) %>%
  # % of landscape infected crop patches with predators (adults / juveniles)
  mutate(fill.level.occ = dyn.inf.occ*100/stock.crops) %>%
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion))

values.for.vline <- data.dyn2 %>%
  select(infection.rate, proportion, agregation, year, tick.full.th) %>%
  distinct() %>%
  mutate(tick.full.th = tick.full.th + 1621)

data.totals2 <- data.totals %>% 
  select(- filename.totals, - crop.loss.1st, - crop.save) %>%
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # normalisation de crop.loss selon le nb de patchs crops dans le paysage
  mutate(norm.crop.loss = crop.loss*100/stock.crops) %>% 
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion))

## ggplot for scenario LA
data.dyn2 %>% 
  # filtre
  filter(year == 10) %>%
  filter(agregation == 1) %>%
  filter(proportion %in% c(10,30,50,70,90)) %>%
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(tick %in% seq(1620, 1769, 1)) %>% 
  # ggplot
  ggplot() + 
  # dynamique des data : taux de remplissage du paysage par inf. -> courbe
  geom_point(mapping = aes(x = tick, y = fill.level, colour = "fill.level"),
             size = 0.5) + 
  geom_point(mapping = aes(x = tick, y = fill.level.non.occ, colour = "fill.level.non.occ"),
             size = 0.5) + 
  geom_point(mapping = aes(x = tick, y = fill.level.occ, colour = "fill.level.occ"),
             size = 0.5) + 
  # dynamique du control
  # geom_point(data = control.dyn %>% 
  #              # select var.
  #             select(- filename.control.dyn, - proba.birth, -proba.overwintering, - init.nb.adults, - visit.count, - tot.inf.cur, - dyn.curation) %>%
  #             # tot crop patches in the landscape
  #             mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  #             # compute tick -> full landscape without pest control
  #             mutate(tick.full.th = ceiling(stock.crops/infection.rate)) %>% 
  #             # infection fill level in the landscape 
  #             mutate(fill.level = dyn.inf*100/stock.crops) %>% 
  #             # infected patches without predators (= control) in % (fill.level)
  #             mutate(fill.level.non.occ = dyn.inf.non.occ*100/stock.crops) %>%  
  #             # filter
  #             filter(agregation == 1) %>%
  #             filter(proportion %in% c(10,30,50,70,90)) %>%
  #             filter(infection.rate %in% c(5,10,15,20)) %>%
  #             filter(year == 10) %>%
  #             filter(tick %in% seq(1620, 1769, 1)),
  # mapping = aes(x = tick, y = fill.level, colour = "fill.level.control"),
  # size = 0.5) +
  # ligne verticale = tick th. auquel le paysage devrait être rempli si pas de contrôle
  geom_vline(data=values.for.vline %>% 
               # same filter than data.dyn
               filter(year == 10) %>%
               filter(agregation == 1) %>%
               filter(proportion %in% c(10,30,50,70,90)) %>%
               filter(infection.rate %in% c(5,10,15,20)) %>% 
               # pour éviter message d'erreur on filtre les valeurs hors limite (x -> tick)
               filter(tick.full.th < 1770),
             aes(xintercept=tick.full.th, colour="tick.full.th"), linetype="dashed", size=1) + 
  # dynamique pests/adults -> courbes
  # geom_point(mapping = aes(x = tick, y = dyn.inf * 100 / 2100, colour = "dyn.inf"),
  #            size = 0.5) + 
  # geom_point(mapping = aes(x = tick, y = dyn.inf.non.occ * 100 / 2100, colour = "dyn.inf.non.occ"),
  #            size = 0.5) + 
  # geom_point(mapping = aes(x = tick, y = dyn.inf.occ * 100 / 2100, colour = "dyn.inf.occ"),
  #            size = 0.5) + 
  geom_point(mapping = aes(x = tick, y = dyn.adults * 100 / (max(dyn.adults)+10), colour = "dyn.adults"),
             size = 0.5) + 
  # crop loss -> segment / point
  geom_segment(data = data.totals2 %>% 
                 # same filter than data.dyn
                 filter(year == 10) %>%
                 filter(agregation == 1) %>%
                 filter(proportion %in% c(10,30,50,70,90)) %>%
                 filter(infection.rate %in% c(5,10,15,20)),
               mapping = aes(x = 1769 , y = crop.loss, yend= 0, xend = 1769), 
               colour="grey50") +
  geom_point(data = data.totals2 %>% 
               # same filter than data.dyn
               filter(year == 10) %>%
               filter(agregation == 1) %>%
               filter(proportion %in% c(10,30,50,70,90)) %>%
               filter(infection.rate %in% c(5,10,15,20)),
             aes(x = 1769, y = crop.loss, colour= "crop.loss"), size=3) +
  # x = ticks de l'année 10
  scale_x_continuous(name = expression("Tick"), 
                     breaks = c(1660, 1700, 1740),
                     labels = c("40","80","120"),
                     limits = c(1620, 1769)) + # les ticks qui nous intéressent
  # y = double axe -> à gauche : taux de remplissage / à droite : dyn. pests et adults
  scale_y_continuous(name = expression("Fill levels (%)"), #left axis
                     sec.axis = sec_axis(~ . * (max(data.dyn$dyn.adults)+10) / 100 , name = "Dynamics of adults (nb.)"), # right axis
                     limits = c(0, 100)) +
  # legends / axes
  scale_colour_manual(values = c("violet","blue", "orange", "cyan", "grey","red", "green")# , 
                      # labels=c("Norm Crop loss","Nb. adults","Nb. infected crop","Occ","Non occ","Fill level by pests","Tick landsc. full")
                      ) +
  # facets
  facet_grid(infection.rate ~ proportion, labeller = label_both) + 
  # titre
  ggtitle("LA (1, y10) :Dynamics of inf. (fill levels) / adults (nb) + crop-loss (total landscape)")

## ggplot for scenario SA
data.dyn2 %>% 
  # filtre
  filter(year == 10) %>%
  filter(agregation == 5) %>%
  filter(proportion %in% c(10,30,50,70,90)) %>%
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(tick %in% seq(1620, 1769, 1)) %>% 
  # ggplot
  ggplot() + 
  # dynamique du taux de remplissage du paysage par inf. -> courbe
  geom_point(mapping = aes(x = tick, y = fill.level, colour = "fill.level"),
             size = 0.5) + 
  geom_point(mapping = aes(x = tick, y = fill.level.non.occ, colour = "fill.level.non.occ"),
             size = 0.5) + 
  geom_point(mapping = aes(x = tick, y = fill.level.occ, colour = "fill.level.occ"),
             size = 0.5) + 
  # dynamique du control
  geom_point(data = control.dyn %>% 
               # select var.
              select(- filename.control.dyn, - proba.birth, -proba.overwintering, - init.nb.adults, - visit.count, - tot.inf.cur, - dyn.curation) %>%
              # tot crop patches in the landscape
              mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
              # compute tick -> full landscape without pest control
              mutate(tick.full.th = ceiling(stock.crops/infection.rate)) %>% 
              # infection fill level in the landscape 
              mutate(fill.level = dyn.inf*100/stock.crops) %>% 
              # infected patches without predators (= control) in % (fill.level)
              mutate(fill.level.non.occ = dyn.inf.non.occ*100/stock.crops) %>%  
              # filter
              filter(agregation == 5) %>%
              filter(proportion %in% c(10,30,50,70,90)) %>%
              filter(infection.rate %in% c(5,10,15,20)) %>%
              filter(year == 10) %>%
              filter(tick %in% seq(1620, 1769, 1)),
  mapping = aes(x = tick, y = fill.level, colour = "fill.level.control"),
  size = 0.5) +
  # ligne verticale = tick th. auquel le paysage devrait être rempli si pas de contrôle
  geom_vline(data=values.for.vline %>% 
               # same filter than data.dyn
               filter(year == 10) %>%
               filter(agregation == 5) %>%
               filter(proportion %in% c(10,30,50,70,90)) %>%
               filter(infection.rate %in% c(5,10,15,20)) %>% 
               # pour éviter message d'erreur on filtre les valeurs hors limite (x -> tick)
               filter(tick.full.th < 1770),
             aes(xintercept=tick.full.th, colour="tick.full.th"), linetype="dashed", size=1) + 
  # dynamique pests/adults -> courbes
  # geom_point(mapping = aes(x = tick, y = dyn.inf * 100 / 2100, colour = "dyn.inf"),
  #            size = 0.5) + 
  # geom_point(mapping = aes(x = tick, y = dyn.inf.non.occ * 100 / 2100, colour = "dyn.inf.non.occ"),
  #            size = 0.5) + 
  # geom_point(mapping = aes(x = tick, y = dyn.inf.occ * 100 / 2100, colour = "dyn.inf.occ"),
  #            size = 0.5) + 
  geom_point(mapping = aes(x = tick, y = dyn.adults * 100 / (max(dyn.adults)+10), colour = "dyn.adults"),
             size = 0.5) + 
  # crop loss -> segment / point
  geom_segment(data = data.totals2 %>% 
                 # same filter than data.dyn
                 filter(year == 10) %>%
                 filter(agregation == 5) %>%
                 filter(proportion %in% c(10,30,50,70,90)) %>%
                 filter(infection.rate %in% c(5,10,15,20)),
               mapping = aes(x = 1769 , y = crop.loss, yend= 0, xend = 1769), 
               colour="grey50") +
  geom_point(data = data.totals2 %>% 
               # same filter than data.dyn
               filter(year == 10) %>%
               filter(agregation == 5) %>%
               filter(proportion %in% c(10,30,50,70,90)) %>%
               filter(infection.rate %in% c(5,10,15,20)),
             aes(x = 1769, y = crop.loss, colour= "crop.loss"), size=3) +
  # x = ticks de l'année 10
  scale_x_continuous(name = expression("Tick"), 
                     breaks = c(1660, 1700, 1740),
                     labels = c("40","80","120"),
                     limits = c(1620, 1769)) + # les ticks qui nous intéressent
  # y = double axe -> à gauche : taux de remplissage / à droite : dyn. pests et adults
  scale_y_continuous(name = expression("Fill levels (%)"), #left axis
                     sec.axis = sec_axis(~ . * (max(data.dyn$dyn.adults)+10) / 100 , name = "Dynamics of adults (nb.)"), # right axis
                     limits = c(0, 100)) +
  # legends / axes
  scale_colour_manual(values = c("violet","blue", "orange", "cyan", "grey","red", "green")# , 
                      # labels=c("Norm Crop loss","Nb. adults","Nb. infected crop","Occ","Non occ","Fill level by pests","Tick landsc. full")
                      ) +
  # facets
  facet_grid(infection.rate ~ proportion, labeller = label_both) + 
  # titre
  ggtitle("SA (5, y10) : Dynamics of inf. (fill levels) / adults (nb) + crop-loss (total landscape)")
```

## With AUC

```{r dynamics.data.AUC}

# data.dyn %>% 
#   # select data we are interested in
#   select(- filename.dyn, - proba.birth, -proba.overwintering, - init.nb.adults, - visit.count, - tot.inf.cur, - dyn.curation) %>%   
#   # tot crop patches in the landscape
#   mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
#   # tick = full landscape without pest control
#   mutate(tick.full.th = ceiling(stock.crops/infection.rate)) %>% 
#   # total infection fill level in the landscape 
#   mutate(fill.level = dyn.inf*100/stock.crops) %>%
#   # % of landscape infected patches without predators (adults / juveniles)
#   mutate(fill.level.non.occ = dyn.inf.non.occ*100/stock.crops) %>%
#   # % of landscape infected crop patches with predators (adults / juveniles)
#   mutate(fill.level.occ = dyn.inf.occ*100/stock.crops) %>%
#   # numeric -> factor (for ggplot)
#   mutate(infection.rate = factor(infection.rate)) %>% 
#   mutate(proportion = factor(proportion)) %>% 
#   # filtre
#   filter(agregation == 1) %>%
#   filter(proportion %in% c(10,30,50,70,90)) %>%
#   filter(infection.rate %in% c(5,10,15,20)) %>% 
#   filter(year == 10) %>%
#   filter(tick %in% seq(1620, 1769, 1)) %>% 
#   # compute AUC (tick, dyn.inf)
#   group_by(proportion, infection.rate) %>% 
#   mutate(auc = AUC(x = tick, y = dyn.inf, method = "trapezoid")) %>% 
#   ungroup() %>% 
#   # plot
#   ggplot() +
#   geom_point(mapping = aes(x = tick, y = auc, colour = "auc"),
#              size = 0.5) + 
#   geom_point(mapping = aes(x = tick, y = dyn.adults, colour = "dyn.adults"),
#              size = 0.5) + 
#   # facets
#   facet_grid(infection.rate ~ proportion, labeller = label_both) + 
#   # titre
#   ggtitle("LA (1, y10) : Dynamics of inf. (AUC) / adults (nb)")
  
```


## Arrivals

```{r arrivals}
# scenarios LA / SA

## scenario LA
data.arrivals %>%
  # jointure nécessite même var.type entre les 2 tables
  mutate(proportion = factor(proportion)) %>% 
  mutate(infection.rate = factor(infection.rate)) %>% 
  # même filtrage que précédemment
  filter(year == 10) %>% 
  filter(agregation == 1) %>% 
  select(filename.arrivals,proportion,infection.rate,tick) %>% 
  group_by(filename.arrivals,proportion,infection.rate,tick) %>% 
  # comptage des occurences d'arrival par tick
  summarise(n.tick = n()) %>% 
  # ungroup for plot
  ungroup() %>% 
  # plot
  ggplot() +
  geom_bar(mapping = aes(x = tick, y = n.tick), stat="identity", fill="white", colour="black") +
  scale_x_continuous(name = expression("Tick"), 
                     breaks = c(1621, 1695, 1769),
                     limits = c(1621, 1769)) +
  facet_grid(infection.rate ~ proportion, labeller = label_both) +
  ggtitle("LA (1, y10) : Distribution of arrivals")

## scenario SA
data.arrivals %>%
  # jointure nécessite même var.type entre les 2 tables
  mutate(proportion = factor(proportion)) %>% 
  mutate(infection.rate = factor(infection.rate)) %>% 
  # même filtrage que précédemment
  filter(year == 10) %>% 
  filter(agregation == 5) %>% 
  select(filename.arrivals,proportion,infection.rate,tick) %>% 
  group_by(filename.arrivals,proportion,infection.rate,tick) %>% 
  # comptage des occurences d'arrival par tick
  summarise(n.tick = n()) %>% 
  # ungroup for plot
  ungroup() %>% 
  # plot
  ggplot() +
  geom_bar(mapping = aes(x = tick, y = n.tick), stat="identity", fill="white", colour="black") +
  scale_x_continuous(name = expression("Tick"), 
                     breaks = c(1621, 1695, 1769),
                     limits = c(1621, 1769)) +
  facet_grid(infection.rate ~ proportion, labeller = label_both) +
  ggtitle("SA (5, y10) : Distribution of arrivals")
```

## Distribution time-since-infection

```{r time.btw.infection.arrivals}
## nb absolu
## scenarios LA / SA

# scenario LA
data.arrivals %>%
  select(filename.arrivals, proportion, agregation, infection.rate, year, t.pest.alone) %>%
  filter(agregation == 1) %>%
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(year == 10) %>%
  group_by(filename.arrivals, proportion, agregation, infection.rate,t.pest.alone) %>% 
  mutate(count.occ = n()) %>% 
  distinct() %>% 
  ungroup() %>% 
  ggplot(aes(x=t.pest.alone, y=count.occ)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(name = "Time since infection, when adults arrive on the infected patch", 
                     breaks = c(6,10,15,20), 
                     limits = c(6,20)) +
  scale_y_continuous(name = "Occurences for each t (time-since-infection)") +
  #geom_hline(data = values.for.hline,
  #           aes(yintercept=count.occ, colour="count.occ.t.pest.alone"), 
  #           linetype="dashed", 
  #           size=1) + 
  facet_grid(infection.rate ~ proportion, labeller = label_both) +
  labs(colour = "Indicator") +
  scale_colour_manual(values = c("red"), labels=c("Max. occ.")) +
  ggtitle("LA (1, y10) : Distribution of occurences for time btw. infection / arrival") 

# scenario SA
data.arrivals %>%
  select(filename.arrivals, proportion, agregation, infection.rate, year, t.pest.alone) %>%
  filter(agregation == 5) %>%
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(year == 10) %>%
  group_by(filename.arrivals, proportion, agregation, infection.rate,t.pest.alone) %>% 
  mutate(count.occ = n()) %>% 
  distinct() %>% 
  ungroup() %>% 
  ggplot(aes(x=t.pest.alone, y=count.occ)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(name = "Time since infection, when adults arrive on the infected patch", 
                     breaks = c(6,10,15,20), 
                     limits = c(6,20)) +
  scale_y_continuous(name = "Occurences for each t (time-since-infection)") +
  #geom_hline(data = values.for.hline,
  #           aes(yintercept=count.occ, colour="count.occ.t.pest.alone"), 
  #           linetype="dashed", 
  #           size=1) + 
  facet_grid(infection.rate ~ proportion, labeller = label_both) +
  labs(colour = "Indicator") +
  scale_colour_manual(values = c("red"), labels=c("Max. occ.")) +
  ggtitle("SA (5, y10) : Distribution of occurences for time btw. infection / arrival") 
```

## Distribution of crop loss values : histogram

```{r crop.loss.distribution.histo}
# scenarios LA /SA
# filter values of crop.loss for crop patches, y10
# round crop.loss values because they have too many decimals
# count occurences of crop.loss values among crop patches
# normalize according to the total of crop patches
# plot

## scenario LA
data.spatial %>% 
  # filter
  filter(land.cover == 1) %>% 
  filter(agregation == 1) %>% 
  filter(year == 10) %>% 
  # less var.
  select(-filename.spatial, -agregation, -year, -pxcor, -pycor, -tick, -nb.cycles, -land.cover, -visit.counter, -crop.save) %>% 
  # round in order to be able to count occ. of crop.loss values
  mutate(crop.loss = round(crop.loss, 3)) %>% 
  # group in order to be able to count occ.
  group_by(proportion, infection.rate, crop.loss) %>% 
  # count occ. of crop loss values
  mutate(count.occ = n()) %>% 
  ungroup() %>% 
  # distinct & arrange
  distinct(proportion, infection.rate, crop.loss, .keep_all = TRUE) %>% 
  arrange(crop.loss) %>% 
  # crop.loss * 100 in order to have % values
  mutate(crop.loss = crop.loss * 100) %>% 
  # stock crop patches
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # normalisation de crop.loss selon le nb de patchs crops dans le paysage
  mutate(norm.count.occ = count.occ*100/stock.crops) %>% 
  # check sum = 100%
  #group_by(proportion, infection.rate) %>% 
  #summarize(somme = sum(norm.count.occ))
  # plot
  ggplot() +
  geom_bar(mapping = aes(x = crop.loss, y = norm.count.occ), stat="identity", fill="white", colour="black") +
  scale_x_continuous(name = expression("Values of crop loss")#, 
                     #breaks = c(1621, 1695, 1769),
                     #limits = c(1621, 1769)
                     ) +
  facet_grid(infection.rate ~ proportion, labeller = label_both) +
  ggtitle("LA (1, y10) : % of crop loss values in distribution")

## scenario SA (agregation 5)
data.spatial %>% 
  # filter
  filter(land.cover == 1) %>% 
  filter(agregation == 5) %>% 
  filter(year == 10) %>% 
  # less var.
  select(-filename.spatial, -agregation, -year, -pxcor, -pycor, -tick, -nb.cycles, -land.cover, -visit.counter, -crop.save) %>% 
  # round in order to be able to count occ. of crop.loss values
  mutate(crop.loss = round(crop.loss, 3)) %>% 
  # group in order to be able to count occ.
  group_by(proportion, infection.rate, crop.loss) %>% 
  # count occ. of crop loss values
  mutate(count.occ = n()) %>% 
  ungroup() %>% 
  # distinct & arrange
  distinct(proportion, infection.rate, crop.loss, .keep_all = TRUE) %>% 
  arrange(crop.loss) %>% 
  # crop.loss * 100 in order to have % values
  mutate(crop.loss = crop.loss * 100) %>% 
  # stock crop patches
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # normalisation de crop.loss selon le nb de patchs crops dans le paysage
  mutate(norm.count.occ = count.occ*100/stock.crops) %>% 
  # check sum = 100%
  #group_by(proportion, infection.rate) %>% 
  #summarize(somme = sum(norm.count.occ))
  # plot
  ggplot() +
  geom_bar(mapping = aes(x = crop.loss, y = norm.count.occ), stat="identity", fill="white", colour="black") +
  scale_x_continuous(name = expression("Values of crop loss")#, 
                     #breaks = c(1621, 1695, 1769),
                     #limits = c(1621, 1769)
                     ) +
  facet_grid(infection.rate ~ proportion, labeller = label_both) +
  ggtitle("SA (1, y10) : % of crop loss values in distribution")
```

## Distribution of crop loss values : boxplots

```{r crop.loss.distribution.boxplots}
# scenarios LA /SA

## scenario LA
data.spatial %>% 
  # filter
  filter(land.cover == 1) %>% 
  filter(agregation == 1) %>% 
  filter(year == 10) %>% 
  # less var.
  select(-filename.spatial, -agregation, -year, -pxcor, -pycor, -tick, -nb.cycles, -land.cover, -visit.counter, -crop.save) %>% 
  # round in order to be able to count occ. of crop.loss values
  mutate(crop.loss = round(crop.loss, 3)) %>%
  # plot
  ggplot() +
  geom_boxplot(aes(x = factor(proportion), y = crop.loss),
               # smaller outliers with white fillings
               outlier.size=1.5, 
               outlier.shape=21,
               # notches
               notch = TRUE) +
  # mean of the crop.loss values distribution -> not working
  # stat_summary(mapping = aes(x, fun.y="mean", geom="point", shape=23, size=3, fill="white")) +
  facet_grid(infection.rate ~ ., labeller = label_both) +
  ggtitle("LA, y 10: Distribution of crop.loss values in crop patches")

## scenario SA
data.spatial %>% 
  # filter
  filter(land.cover == 1) %>% 
  filter(agregation == 5) %>% 
  filter(year == 10) %>% 
  # less var.
  select(-filename.spatial, -agregation, -year, -pxcor, -pycor, -tick, -nb.cycles, -land.cover, -visit.counter, -crop.save) %>% 
  # round in order to be able to count occ. of crop.loss values
  mutate(crop.loss = round(crop.loss, 3)) %>%
  # plot
  ggplot() +
  geom_boxplot(aes(x = factor(proportion), y = crop.loss),
               # smaller outliers with white fillings
               outlier.size=1.5, 
               outlier.shape=21,
               # notches
               notch = TRUE) +
  # mean of the crop.loss values distribution -> not working
  # stat_summary(mapping = aes(x, fun.y="mean", geom="point", shape=23, size=3, fill="white")) +
  facet_grid(infection.rate ~ ., labeller = label_both) +
  ggtitle("SA, y10 : Distribution of crop.loss values in crop patches")
```

## Crop-loss (total on landscape)

```{r crop.loss}
# scenarios SA / LA

## LA
data.totals %>% 
  # filter
  filter(agregation == 1) %>% 
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(proportion %in% c(10,30,50,70,90)) %>% 
  filter(year == 10) %>% 
  # data type (data = with predators, sinon control)
  mutate(type = factor('data')) %>% 
  # -> factors
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion)) %>% 
  # bind 'data' (with predators) with 'control'
  bind_rows(control.totals %>% 
              # filter
              filter(agregation == 1) %>% 
              filter(infection.rate %in% c(5,10,15,20)) %>% 
              filter(proportion %in% c(10,30,50,70,90)) %>% 
              filter(year == 10) %>% 
              # data type (data = with predators, sinon control)
              mutate(type = factor('control')) %>% 
              # -> factor
              mutate(infection.rate = factor(infection.rate)) %>% 
              mutate(proportion = factor(proportion))) %>% 
  # plot
  ggplot() +
  geom_point(aes(x = proportion, y =  crop.loss, colour = type)) +
  # facets
  facet_grid(infection.rate ~ ., labeller = label_both) +
  # title
  ggtitle("LA, y10 : Crop loss (total landscape) btw. control / with predators")

## SA
data.totals %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(proportion %in% c(10,30,50,70,90)) %>% 
  filter(year == 10) %>% 
  # data type (data = with predators, ow. control)
  mutate(type = factor('data')) %>% 
  # -> factors
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion)) %>% 
  # bind 'data' (with predators) with 'control'
  bind_rows(control.totals %>% 
              # filter
              filter(agregation == 5) %>% 
              filter(infection.rate %in% c(5,10,15,20)) %>% 
              filter(proportion %in% c(10,30,50,70,90)) %>% 
              filter(year == 10) %>% 
              # data type (data = with predators, ow. control)
              mutate(type = factor('control')) %>% 
              # -> factor
              mutate(infection.rate = factor(infection.rate)) %>% 
              mutate(proportion = factor(proportion))) %>% 
  # plot
  ggplot() +
  geom_point(aes(x = proportion, y =  crop.loss, colour = type)) +
  # geom_line(aes(x = proportion, y =  crop.loss, colour = type)) +
  # facets
  facet_grid(infection.rate ~ ., labeller = label_both) +
  # title
  ggtitle("SA, y10 : Crop loss (total landscape) btw. control / with predators")
```


## Normalized crop-loss

```{r norm.crop.loss}
# scenarios SA / LA

# compute norm.crop.loss for control.totals / data.totals

control.totals2 <- control.totals %>% 
  select(- filename.control.totals, - crop.loss.1st, - crop.save) %>%
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # normalisation de crop.loss selon le nb de patchs crops dans le paysage
  mutate(norm.crop.loss = crop.loss*100/stock.crops) %>% 
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion))

data.totals2 <- data.totals %>% 
  select(- filename.totals, - crop.loss.1st, - crop.save) %>%
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # normalisation de crop.loss selon le nb de patchs crops dans le paysage
  mutate(norm.crop.loss = crop.loss*100/stock.crops) %>% 
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion))

## LA
data.totals2 %>% 
  # filter
  filter(agregation == 1) %>% 
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(proportion %in% c(10,30,50,70,90)) %>% 
  filter(year == 10) %>% 
  # data type (data = with predators, ow. control)
  mutate(type = factor('data')) %>% 
  # -> factors
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion)) %>% 
  # bind 'data' (with predators) with 'control'
  bind_rows(control.totals2 %>% 
              # filter
              filter(agregation == 1) %>% 
              filter(infection.rate %in% c(5,10,15,20)) %>% 
              filter(proportion %in% c(10,30,50,70,90)) %>% 
              filter(year == 10) %>% 
              # data type (data = with predators, ow. control)
              mutate(type = factor('control')) %>% 
              # -> factor
              mutate(infection.rate = factor(infection.rate)) %>% 
              mutate(proportion = factor(proportion))) %>% 
  # plot
  ggplot() +
  geom_point(aes(x = proportion, y =  norm.crop.loss, colour = type)) +
  # facets
  facet_grid(infection.rate ~ ., labeller = label_both) +
  # title
  ggtitle("LA, y10 : Normalized crop loss btw. control / with predators")

## SA
data.totals2 %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(proportion %in% c(10,30,50,70,90)) %>% 
  filter(year == 10) %>% 
  # data type (data = with predators, ow. control)
  mutate(type = factor('data')) %>% 
  # -> factors
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion)) %>% 
  # bind 'data' (with predators) with 'control'
  bind_rows(control.totals2 %>% 
              # filter
              filter(agregation == 5) %>% 
              filter(infection.rate %in% c(5,10,15,20)) %>% 
              filter(proportion %in% c(10,30,50,70,90)) %>% 
              filter(year == 10) %>% 
              # data type (data = with predators, ow. control)
              mutate(type = factor('control')) %>% 
              # -> factor
              mutate(infection.rate = factor(infection.rate)) %>% 
              mutate(proportion = factor(proportion))) %>% 
  # plot
  ggplot() +
  geom_point(aes(x = proportion, y =  norm.crop.loss, colour = type)) +
  # facets
  facet_grid(infection.rate ~ ., labeller = label_both) +
  # title
  ggtitle("SA, y10 : Normalized crop loss btw. control / with predators")
```

## Differences btw. control / data for crop.loss / norm.crop.loss

```{r diff.control.data}
# ATTENTION : code pas top -> améliorable
# subset 'control' / 'data'
# diff entre 'control' et 'data' pour les 2 indicateurs : crop.loss & norm.crop.loss
# on plot ces diff

## scenario LA

d.LA <-  data.totals %>% 
  select(- filename.totals, - crop.loss.1st, - crop.save) %>%
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # normalisation de crop.loss selon le nb de patchs crops dans le paysage
  mutate(norm.crop.loss = crop.loss*100/stock.crops) %>% 
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion)) %>% 
  # filter
  filter(agregation == 1) %>% 
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(proportion %in% c(10,30,50,70,90)) %>% 
  filter(year == 10) %>% 
  # data type (data = with predators, ow. control)
  mutate(type = factor('data')) %>% 
  # -> factors
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion)) %>% 
  # bind 'data' (with predators) with 'control'
  bind_rows(control.totals2 %>% 
              # filter
              filter(agregation == 1) %>% 
              filter(infection.rate %in% c(5,10,15,20)) %>% 
              filter(proportion %in% c(10,30,50,70,90)) %>% 
              filter(year == 10) %>% 
              # data type (data = with predators, ow. control)
              mutate(type = factor('control')) %>% 
              # -> factor
              mutate(infection.rate = factor(infection.rate)) %>% 
              mutate(proportion = factor(proportion))) %>% 
  # réduction jeu de données
  select(- agregation, - year, - stock.crops)

d.control.LA <- d.LA %>% 
  filter(type == 'control') %>% 
  arrange(infection.rate, proportion)

d.LA <- d.LA %>% 
  filter(type == 'data') %>% 
  arrange(infection.rate, proportion) %>% 
  mutate(diff.cl = d.control.LA$crop.loss - crop.loss) %>% 
  mutate(diff.ncl = d.control.LA$norm.crop.loss - norm.crop.loss)

## ggplot des diff
d.LA %>% 
  ggplot() +
  geom_point(aes(x = proportion, y =  diff.cl, colour = "diff.cl"), size = 2) +
  geom_line(aes(x = proportion, y =  diff.cl, colour = "diff.cl", group = 1)) +
  geom_point(aes(x = proportion, y =  diff.ncl * (max(d.LA$diff.cl)) / 100, colour = "diff.ncl"), size = 2) +
  geom_line(aes(x = proportion, y =  diff.ncl * (max(d.LA$diff.cl)) / 100, colour = "diff.ncl", group = 1)) +
  # axes y
  scale_y_continuous(name = expression("diff.cl"), 
                     sec.axis = sec_axis(~ . / (max(d.LA$diff.cl)) * 100 , name = "diff.ncl")) +
  # facets
  facet_grid(infection.rate ~ ., labeller = label_both) +
  ggtitle("LA : diff.cl and diff.ncl")

## scenario SA

d.SA <-  data.totals %>% 
  select(- filename.totals, - crop.loss.1st, - crop.save) %>%
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # normalisation de crop.loss selon le nb de patchs crops dans le paysage
  mutate(norm.crop.loss = crop.loss*100/stock.crops) %>% 
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion)) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(infection.rate %in% c(5,10,15,20)) %>% 
  filter(proportion %in% c(10,30,50,70,90)) %>% 
  filter(year == 10) %>% 
  # data type (data = with predators, ow. control)
  mutate(type = factor('data')) %>% 
  # -> factors
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion)) %>% 
  # bind 'data' (with predators) with 'control'
  bind_rows(control.totals2 %>% 
              # filter
              filter(agregation == 5) %>% 
              filter(infection.rate %in% c(5,10,15,20)) %>% 
              filter(proportion %in% c(10,30,50,70,90)) %>% 
              filter(year == 10) %>% 
              # data type (data = with predators, ow. control)
              mutate(type = factor('control')) %>% 
              # -> factor
              mutate(infection.rate = factor(infection.rate)) %>% 
              mutate(proportion = factor(proportion))) %>% 
  # réduction jeu de données
  select(- agregation, - year, - stock.crops)

d.control.SA <- d.SA %>% 
  filter(type == 'control') %>% 
  arrange(infection.rate, proportion)

d.SA <- d.SA %>% 
  filter(type == 'data') %>% 
  arrange(infection.rate, proportion) %>% 
  mutate(diff.cl = d.control.SA$crop.loss - crop.loss) %>% 
  mutate(diff.ncl = d.control.SA$norm.crop.loss - norm.crop.loss)

## ggplot des diff
d.SA %>% 
  ggplot() +
  geom_point(aes(x = proportion, y =  diff.cl, colour = "diff.cl"), size = 2) +
  geom_line(aes(x = proportion, y =  diff.cl, colour = "diff.cl", group = 1)) +
  geom_point(aes(x = proportion, y =  diff.ncl * (max(d.SA$diff.cl)) / 100, colour = "diff.ncl"), size = 2) +
  geom_line(aes(x = proportion, y =  diff.ncl * (max(d.SA$diff.cl)) / 100, colour = "diff.ncl", group = 1)) +
  # axes y
  scale_y_continuous(name = expression("diff.cl"), 
                     sec.axis = sec_axis(~ . / (max(d.SA$diff.cl)) * 100 , name = "diff.ncl")) +
  # facets
  facet_grid(infection.rate ~ ., labeller = label_both) +
  ggtitle("SA : diff.cl and diff.ncl")
```


