---
title: "30 mai"
author: "Antoine"
date: \`r format(Sys.Date(), "%m %d,%Y")`\
output:
  slidy_presentation: default
---

```{r setup, include=FALSE}
rm(list=ls())

# packages
library(tidyverse)
library(DescTools)
library(tis)


# options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.height = 6, fig.width = 13, fig.align = "center")
```

```{r multiplot function}

# multiplot function : several ggplot on the same page

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

```{r load data dyn.}
## wd
data_path <- "data/inf-rate-4"

## dyn
filename.dyn <- list.files(data_path, 
                           pattern="^tick-[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt")

column.names.dyn <- c(
  # init.params
  "infection.rate",
  "proportion",
  "agregation",
  "proba.overwintering",
  "nb.init",
  "proba.birth",
  # time
  "year",
  "tick",
  # outputs
  "nb.visited.patches",
  "dyn.never.inf",
  "dyn.inf",
  "dyn.inf.non.occ",
  "dyn.inf.occ",
  "dyn.cured",
  "dyn.adults",
  "tot.inf.cur",
  "dyn.curation")

## load -> data.dyn contient toutes les données, y compris le control (nb.init 0 / proportion 0)

data.dyn <- tibble(filename.dyn) %>% 
  # load whole data
  mutate(file_contents = map(filename.dyn, ~ read_delim(file.path(data_path, .), delim = " ", col_names = column.names.dyn))) %>% 
  unnest()
```

# Traitement de plusieurs simulations

## Dyn. inf . : variabilité entre simulations

- Chaque config. : 10 simulations (1 couleur par simulation)
- Valeurs = nb. de patches avec statut infecté


```{r inf variance simul Y1 Y5}
plotY1 <- data.dyn %>% 
  # filter Y1
  filter(year == 1) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = dyn.inf, colour = filename.dyn)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  # on enlève la légende (illisible)
  guides(colour=FALSE)

plotY5 <- data.dyn %>% 
  # filter Y5
  filter(year == 5) %>%
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = dyn.inf, colour = filename.dyn)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  # on enlève la légende (illisible)
  guides(colour=FALSE)

multiplot(plotY1, plotY5, rows=2)
```

## Dyn. inf. : comparaisons entre mean et median : Year 1

- dyn. inf. = taux de remplissage (normalisé par le nb. de crop patches)
- mean / median sur les 10 simuls pour chaque config.

```{r inf comparison mean median Y1}

### mean

data.dyn.mean <- data.dyn %>% 
  # average dyn.inf : mean
  group_by(infection.rate, proportion, agregation, nb.init, year, tick) %>% 
  mutate(mean.inf = mean(dyn.inf)) %>% 
  distinct(infection.rate, proportion, agregation, nb.init, year, tick, .keep_all = TRUE) %>% 
  ungroup() %>% 
  # classic data.dyn2
  # select data we are interested in
  select(- filename.dyn, - proba.birth, -proba.overwintering, - nb.visited.patches, - tot.inf.cur, - dyn.curation) %>%   
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # % of landscape infected : average dyn.inf -> mean.inf
  mutate(fill.level = mean.inf*100/stock.crops) %>%
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion))

plot.mean <- data.dyn.mean %>% 
  # Y1
  filter(year == 1) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = fill.level)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Mean 10 simulations Y1")

### median

data.dyn.median <- data.dyn %>% 
  # average dyn.inf : mean
  group_by(infection.rate, proportion, agregation, nb.init, year, tick) %>% 
  mutate(median.inf = median(dyn.inf)) %>% 
  distinct(infection.rate, proportion, agregation, nb.init, year, tick, .keep_all = TRUE) %>% 
  ungroup() %>% 
  # classic data.dyn2
  # select data we are interested in
  select(- filename.dyn, - proba.birth, -proba.overwintering, - nb.visited.patches, - tot.inf.cur, - dyn.curation) %>%   
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # % of landscape infected : average dyn.inf -> mean.inf
  mutate(fill.level = median.inf*100/stock.crops) %>%
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion))

plot.median <- data.dyn.median %>% 
  # Y1
  filter(year == 1) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = fill.level)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Median 10 simulations Y1")

### multiplot comparison mean / median

multiplot(plot.mean, plot.median, rows=2)
```

## Dyn. inf. : comparaisons entre mean et median : Year 5

```{r inf comparison mean median Y5}

### mean

plot.mean <- data.dyn.mean %>% 
  # Y5
  filter(year == 5) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = fill.level)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Mean 10 simulations Y5")

### median

plot.median <- data.dyn.median %>% 
  # Y5
  filter(year == 5) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = fill.level)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Median 10 simulations Y5")

### multiplot comparison mean / median

multiplot(plot.mean, plot.median, rows=2)
```

## Dyn. pred. : variabilité entre simulations

- Chaque config. : 10 simulations (1 couleur par simulation)
- Valeurs = nb. de predators

```{r pred variance simul Y1 Y5}
plotY1 <- data.dyn %>% 
  # filter Y1
  filter(year == 1) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = dyn.adults, colour = filename.dyn)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  # on enlève la légende (illisible)
  guides(colour=FALSE)

plotY5 <- data.dyn %>% 
  # filter Y5
  filter(year == 5) %>%
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = dyn.adults, colour = filename.dyn)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  # on enlève la légende (illisible)
  guides(colour=FALSE)

multiplot(plotY1, plotY5, rows=2)
```


## Dyn. pred. : comparaisons entre mean et median : Year 1

- dyn. inf. = taux de remplissage (normalisé par le nb. de crop patches)
- mean / median sur les 10 simuls pour chaque config.

```{r pred comparison mean median Y1}

### mean

data.dyn.mean <- data.dyn %>% 
  # average dyn.adults : mean
  group_by(infection.rate, proportion, agregation, nb.init, year, tick) %>% 
  mutate(mean.adults = mean(dyn.adults)) %>% 
  distinct(infection.rate, proportion, agregation, nb.init, year, tick, .keep_all = TRUE) %>% 
  ungroup() %>% 
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion))

plot.mean <- data.dyn.mean %>% 
  # Y1
  filter(year == 1) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = mean.adults)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Mean 10 simulations Y1")

### median

data.dyn.median <- data.dyn %>% 
  # average dyn.adults : mean
  group_by(infection.rate, proportion, agregation, nb.init, year, tick) %>% 
  mutate(median.adults = median(dyn.adults)) %>% 
  distinct(infection.rate, proportion, agregation, nb.init, year, tick, .keep_all = TRUE) %>% 
  ungroup() %>% 
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion))

plot.median <- data.dyn.median %>% 
  # Y1
  filter(year == 1) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = median.adults)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Median 10 simulations Y1")

### multiplot comparison mean / median

multiplot(plot.mean, plot.median, rows=2)
```

## Dyn. pred. : comparaisons entre mean et median : Year 5

```{r pred comparison mean median Y5}

### mean

plot.mean <- data.dyn.mean %>% 
  # Y5
  filter(year == 5) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = mean.adults)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Mean 10 simulations Y5")

### median

plot.median <- data.dyn.median %>% 
  # Y5
  filter(year == 5) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(infection.rate == 4) %>% 
  ggplot() +
  geom_point(aes(x = tick, y = median.adults)) +
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Median 10 simulations Y5")

### multiplot comparison mean / median

multiplot(plot.mean, plot.median, rows=2)
```

# Inf. rate = 4

## Expérience

- infection-rate = 4
- 10 simulations -> mean

- 5 years
- agregation 1/5
- proportion 0-10-90
- nb. init. : 0/5/10
- proba.mortality 0.1

```{r data.dyn.mean}

# mean sur 10 simulations pour toutes les var. relatives à la dyn. des pests
# -> en % pour normaliser par rapport au nb de crop patches

data.dyn.mean <- data.dyn %>% 
  # average : mean
  group_by(infection.rate, proportion, agregation, nb.init, year, tick) %>% 
  mutate(mean.inf = mean(dyn.inf)) %>% 
  mutate(mean.never.inf = mean(dyn.never.inf)) %>% 
  mutate(mean.inf.non.occ = mean(dyn.inf.non.occ)) %>% 
  mutate(mean.inf.occ = mean(dyn.inf.occ)) %>% 
  mutate(mean.cured = mean(dyn.cured)) %>% 
  # adults
  mutate(mean.adults = mean(dyn.adults)) %>% 
  distinct(infection.rate, proportion, agregation, nb.init, year, tick, .keep_all = TRUE) %>% 
  ungroup() %>% 
  # select data we are interested in
  select(- filename.dyn, - proba.birth, -proba.overwintering, - nb.visited.patches, - tot.inf.cur, - dyn.curation) %>%   
  # tot crop patches in the landscape
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  # % of landscape infected (fl = fill level)
  mutate(fl.inf = mean.inf*100/stock.crops) %>%
  # % of landscape never infected
  mutate(fl.never.inf = mean.never.inf*100/stock.crops) %>%
  # % of landscape infected patches without predators (adults / juveniles)
  mutate(fl.non.occ = mean.inf.non.occ*100/stock.crops) %>%
  # % of landscape infected crop patches with predators (adults / juveniles)
  mutate(fl.occ = mean.inf.occ*100/stock.crops) %>%
  # % of landscape infected ad then cured
  mutate(fl.cured = mean.cured*100/stock.crops) %>%
  # numeric -> factor (for ggplot)
  mutate(infection.rate = factor(infection.rate)) %>% 
  mutate(proportion = factor(proportion))
```

```{r load data distribution time.for.crop.loss}
data_path <- "data/inf-rate-4"

## dyn
filename.pred.event <- list.files(data_path, 
                           pattern="^pred-event-[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt")

column.names.tforcroploss <- c(
  # par.
  "proportion",
  "agregation", 
  "infection.rate",
  "nb.init",
  # time
  "year", 
  "tick",
  # outputs
  "event",
  "pxcor",
  "pycor",
  "infection.date",
  "t.for.crop.loss")


## load 

data.tforcroploss <- tibble(filename.pred.event) %>% 
  mutate(file_contents = map(filename.pred.event, ~ read_delim(file.path(data_path, .), delim = " ", col_names = column.names.tforcroploss))) %>% 
  unnest()
```

```{r mean time.for.crop.loss}
data.tforcroploss.mean <- data.tforcroploss %>%
  select(filename.pred.event, infection.rate, proportion, agregation, nb.init, year, t.for.crop.loss) %>% 
  group_by(filename.pred.event, t.for.crop.loss) %>% 
  mutate(count = n()) %>% 
  ungroup() %>% 
  group_by(infection.rate, proportion, agregation, nb.init, year, t.for.crop.loss) %>% 
  mutate(mean.count = mean(count)) %>% 
  ungroup() %>% 
  select(-filename.pred.event, - count) %>% 
  distinct()
```

```{r load data crop.loss landscape}
data_path <- "data/inf-rate-4"

## dyn
filename.end.season <- list.files(data_path, 
                                  pattern="^end-season-[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt")

column.names.end.season <- c(
  # par.
  "infection.rate",
  "proportion",
  "agregation", 
  "nb.init",
  # time
  "year", 
  # outputs
  "lsc.tot.crop.loss")

## load 

data.end.season <- tibble(filename.end.season) %>% 
  mutate(file_contents = map(filename.end.season, ~ read_delim(file.path(data_path, .), delim = " ", col_names = column.names.end.season))) %>% 
  unnest()
```

```{r mean data crop.loss landscape}
# on a 10 simulations par cnfig -> mean(10 values of crop.loss)
data.end.season.mean <- data.end.season %>% 
  group_by(infection.rate, proportion, agregation, nb.init, year) %>% 
  mutate(mean.lsc.tot.crop.loss = mean(lsc.tot.crop.loss)) %>% 
  select(-filename.end.season) %>% 
  distinct()
```

```{r load data for distribution of crop.loss values for crop patches}
data_path <- "data/inf-rate-4"

## dyn
filename.spatial <- list.files(data_path, 
                                  pattern="^spatial-[0-9]{1,4}-[0-9]{1,2}-[0-9]{1,2}-[0-9]{1,2}.txt")

column.names.spatial <- c(
  # par.
  "proportion",
  "agregation", 
  "infection.rate",
  "nb.init",
  # time
  "year", 
  "tick",
  # spatial
  "pxcor",
  "pycor",
  "land.cover",
  # outputs
  "nb.visits",
  "nb.cycles",
  "time.for.crop.loss",
  "tot.crop.loss")

## load 
data.spatial <- tibble(filename.spatial) %>% 
  mutate(file_contents = map(filename.spatial, ~ read_delim(file.path(data_path, .), delim = " ", col_names = column.names.spatial))) %>% 
  unnest()
```

```{r mean data distribution of crop.loss values for crop patches}
data.spatial.mean <- data.spatial %>% 
  # filter
  filter(land.cover == 1) %>% 
  # mean value of total crop loss for one patch (10 simulations)
  group_by(infection.rate, proportion, agregation, nb.init, year, pxcor, pycor) %>% 
  summarize(mean.tot.crop.loss = mean(tot.crop.loss)) %>% 
  ungroup()
```


## Dyn. inf. 

```{r inf without pred VS inf with pred}
data.dyn.mean %>% 
  # control
  filter(nb.init == 0) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  filter(infection.rate == 4) %>% 
  # plot
  ggplot() +
  # control
  geom_point(mapping = aes(x = tick, y = fl.inf, colour = "Inf. without pred."),
             size = 0.5) + 
  # data (= with pred)
  ## inf.
  geom_point(data = data.dyn.mean %>% 
               # même filtre que control
               filter(agregation == 5) %>%
               filter(year == 5) %>%
               filter(infection.rate == 4) %>% 
               # on rajoute un filtre sur nb.init (plusieurs modalités possibles dans le jeu)
               filter(nb.init == 10),
             mapping = aes(x = tick, y = fl.inf, colour = "Inf. with pred."),
             size = 0.5) + 
  ylab("Percentage of crops") +
  facet_grid(infection.rate ~ proportion, labeller = label_both) +
  ggtitle("Dynamic of crop patches with pests \nMean 10 simul, Agregation = 5, Year = 5, nb init pred = 10")
```

## Max. infection = nb. max de crop patches infectés

```{r max. inf.}
data.dyn.mean %>% 
  select(infection.rate, proportion, agregation, nb.init, year, mean.inf) %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  # filter
  filter(nb.init == 10) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  group_by(proportion) %>% 
  mutate(max.mean.inf = max(mean.inf)) %>% 
  select(- mean.inf) %>% 
  distinct() %>% 
  # plot according to proportion
  ggplot() +
  geom_point(aes(x = proportion, y = max.mean.inf, colour = "max.mean.inf")) +
  ylab("Max. infected crop patches") +
  ggtitle("Max. infection (nb. infected crop patches) \nMean 10 simul, Agregation = 5, Year = 5, nb init pred = 10")
```

## Découpage occ. VS non.occ

```{r never inf VS occ VS non.occ VS cured}
data.dyn.mean %>% 
  # filter
  filter(nb.init == 10) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  filter(infection.rate == 4) %>% 
  # plot
  ggplot() +
  geom_point(mapping = aes(x = tick, y = fl.never.inf, colour = "Never inf."),
             size = 0.5) + 
  geom_point(mapping = aes(x = tick, y = fl.non.occ, colour = "Inf. non.occ"),
             size = 0.5) + 
  geom_point(mapping = aes(x = tick, y = fl.occ, colour = "Inf. occ."),
             size = 0.5) + 
  geom_point(mapping = aes(x = tick, y = fl.cured, colour = "Cured"),
             size = 0.5) + 
  ylab("Percentage of crops") +
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Dynamic of crop patches with pests \nMean 10 simul, Agregation = 5, Year = 5, nb init pred = 10")
```

## audpc VS end.inf.non.occ VS proportion VS crop-loss 

```{r audpc VS end.inf.non.occ VS proportion VS crop-loss landscape }

# on fait un tableau proportion / value (audpc, end.inf.non.occ, crop-loss landscape)

data.audpc.inf <- data.dyn.mean %>% 
  select(infection.rate, proportion, agregation, nb.init, year, tick, fl.inf) %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  # filter
  filter(nb.init == 10) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  # audpc inf
  group_by(proportion) %>% 
  mutate(audpc.inf = sum(lintegrate(tick, fl.inf, xint=tick))) %>% 
  select(proportion, audpc.inf) %>% 
  ungroup() %>% 
  distinct()

data.end.inf.non.occ <- data.dyn.mean %>% 
  select(infection.rate, proportion, agregation, nb.init, year, tick, fl.non.occ) %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  # filter
  filter(nb.init == 10) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  # filter end.season
  filter(tick == 900) %>% 
  select(proportion, fl.non.occ)

data.crop.loss.lsc <- data.end.season.mean %>% 
  ungroup() %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  # filter
  filter(nb.init == 10) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  select(-lsc.tot.crop.loss) %>% 
  select(proportion, mean.lsc.tot.crop.loss) %>% 
  distinct() %>% 
  mutate(proportion = as.factor(proportion))

data.plot <- data.audpc.inf %>% 
  left_join(data.end.inf.non.occ, by = "proportion") %>% 
  left_join(data.crop.loss.lsc, by = "proportion")

data.plot %>% 
  ggplot()+
  geom_point(mapping = aes(x = proportion, y = fl.non.occ, colour = "Nb. crop patches infected but non occ.")) +
  geom_point(mapping = aes(x = proportion, y = mean.lsc.tot.crop.loss, colour = "Total crop loss landscape")) +
  geom_point(mapping = aes(x = proportion, y = audpc.inf * max(mean.lsc.tot.crop.loss) / max(audpc.inf), colour = "Audpc.inf")) +
  scale_y_continuous(name = expression("Green and Blue"), #left axis
                     sec.axis = sec_axis(~ . * max(data.plot$audpc.inf) / max(data.plot$mean.lsc.tot.crop.loss) , name = "Red")) +
  ggtitle("audpc infection + nb. of infected crop patches at end season + crop loss landscape \nAgregation = 5, Year = 5, nb.init = 10")

```

## AUDPCs

```{r AUDPC inf control VS inf with regul}

# on détermine l'audpc de la courbe inf. pour nb.init = 0 -> control
# on détermine l'audpc de la courbe inf. pour nb.init != 0 -> with regulation of pests by predators
# on plot les deux valeurs en f° de proportion

data.dyn.mean %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  # filter
  filter(nb.init == 10) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  # compute audpc for inf.
  select(year, tick, proportion, fl.inf) %>% 
  group_by(proportion) %>% 
  mutate(audpc.inf = sum(lintegrate(tick, fl.inf, xint=tick))) %>%
  ungroup() %>% 
  select(year, proportion, audpc.inf) %>% 
  distinct() %>% 
  # plot according to proportion
  ggplot() +
  geom_point(aes(x = proportion, y = audpc.inf, colour = "audpc inf.")) +
  geom_point(data = data.dyn.mean %>% 
               # inf.rate = 4
               filter(infection.rate == 4) %>% 
               # filter control
               filter(nb.init == 0) %>% 
               # filter
               filter(agregation == 5) %>%
               filter(year == 5) %>% 
               # compute audpc for inf.
               select(year, tick, proportion, fl.inf) %>% 
               group_by(proportion) %>% 
               mutate(audpc.inf.control = sum(lintegrate(tick, fl.inf, xint=tick))) %>% 
               ungroup() %>% 
               select(year, proportion, audpc.inf.control) %>% 
               distinct(),
             aes(x = proportion, y = audpc.inf.control, colour = "audpc inf. control")) +
  ggtitle("AUDPC inf. control (nb.init = 0) VS inf. with regul. \nMean 10 simul, Agregation = 5, Year = 5, nb init pred = 10")
```



```{r AUDPCs}
# 2 plots pour être + lisible
# plot.audpc1 -> audpc croissantes ou décroissantes strictement
# plot.audoc2 -> audpc non monotones

plot.audpc1 <- data.dyn.mean %>% 
  filter(nb.init == 10) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  filter(infection.rate == 4) %>% 
  select(year, tick, proportion, fl.inf, fl.never.inf, fl.non.occ, fl.occ, fl.cured) %>% 
  # compute audpc for every inf.
  group_by(proportion) %>% 
  mutate(audpc.inf = sum(lintegrate(tick, fl.inf, xint=tick))) %>%
  mutate(audpc.never.inf = sum(lintegrate(tick, fl.never.inf, xint=tick))) %>% 
  mutate(audpc.non.occ = sum(lintegrate(tick, fl.non.occ, xint=tick))) %>% 
  mutate(audpc.occ = sum(lintegrate(tick, fl.occ, xint=tick))) %>% 
  mutate(audpc.cured = sum(lintegrate(tick, fl.cured, xint=tick))) %>% 
  # plot according to proportion
  ggplot() +
  geom_point(aes(x = proportion, y = audpc.never.inf, colour = "audpc never inf.")) +
  geom_point(aes(x = proportion, y = audpc.cured, colour = "audpc cured")) +
  ggtitle("AUDPCs \nMean 10 simul, Agregation = 5, Year = 5, nb init pred = 10")

plot.audpc2 <- data.dyn.mean %>% 
  filter(nb.init == 10) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  filter(infection.rate == 4) %>% 
  select(year, tick, proportion, fl.inf, fl.never.inf, fl.non.occ, fl.occ, fl.cured) %>% 
  # compute audpc for every inf.
  group_by(proportion) %>% 
  mutate(audpc.inf = sum(lintegrate(tick, fl.inf, xint=tick))) %>%
  mutate(audpc.never.inf = sum(lintegrate(tick, fl.never.inf, xint=tick))) %>% 
  mutate(audpc.non.occ = sum(lintegrate(tick, fl.non.occ, xint=tick))) %>% 
  mutate(audpc.occ = sum(lintegrate(tick, fl.occ, xint=tick))) %>% 
  mutate(audpc.cured = sum(lintegrate(tick, fl.cured, xint=tick))) %>% 
  # plot according to proportion
  ggplot() +
  geom_point(aes(x = proportion, y = audpc.inf, colour = "audpc inf.")) +
  geom_point(aes(x = proportion, y = audpc.non.occ, colour = "audpc non occ.")) +
  geom_point(aes(x = proportion, y = audpc.occ, colour = "audpc occ.")) +
  ggtitle("AUDPCs \nMean 10 simul, Agregation = 5, Year = 5, nb init pred = 10")

multiplot(plot.audpc1, plot.audpc2, cols = 2)

```

## Occ. VS non.occ VS adults

```{r occ VS non occ VS adults}
data.dyn.mean %>% 
  # inf.rate 4
  filter(infection.rate == 4) %>% 
  # filter
  filter(nb.init == 10) %>% 
  filter(agregation == 5) %>%
  filter(year == 5) %>% 
  # plot
  ggplot() +
  ## inf. non.occ
  geom_point(mapping = aes(x = tick, y = fl.inf, colour = "Inf."),
            size = 0.5) + 
  # dyn. adults
  geom_point(mapping = aes(x = tick, y = mean.adults * 100 / (max(mean.adults)+10), colour = "Mean nb. adults"),
            size = 0.5) + 
  # y = double axe -> à gauche : taux de remplissage / à droite : dyn. pests et adults
  scale_y_continuous(name = expression("Percentage of infected crops"), #left axis
                     sec.axis = sec_axis(~ . * (max(data.dyn.mean$mean.adults)+10) / 100 , name = "Nb. of pred. adults"), # right axis
                     limits = c(0, 100)) +
  # facets
  facet_grid(. ~ proportion, labeller = label_both) +
  ggtitle("Inf. & preds. \n Agregation = 5, Year = 5, nb init pred = 10)")
```

## Distribution of infection.events

à faire


## Distribution of time.for.crop.loss

Remarque : on ne mesure pas time/for.crop.loss pour les crop patches infectés qui ne reçoivent jamais de prédateurs

2 scénarios de proportion :

- faible proportion = 10% de SNH -> hyp. : distribution étalée
- forte proportion = 90% de SNH -> hyp. : distribution + resserrée vers faibles valeurs

```{r plot time.for.crop.loss 2 scenarios proportion}
plot1 <- data.tforcroploss.mean %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  # Scenario Low proportion
  filter(proportion == 10) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(year == 5) %>% 
  filter(nb.init == 10) %>%  # plot
  ggplot() +
  geom_bar(aes(x=t.for.crop.loss, y=mean.count), 
           stat = "identity") +  
  xlab("Time between pest and predator arrivals") +
  ylab("Nb. of occurences") +
  ggtitle("Low proportion = 10% \nAgregation = 5, Year = 5, inf.rate = 4, nb.init = 10")


plot2 <- data.tforcroploss.mean %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  # Scenario Low proportion
  filter(proportion == 90) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(year == 5) %>% 
  filter(nb.init == 10) %>%  # plot
  ggplot() +
  geom_bar(aes(x=t.for.crop.loss, y=mean.count), 
           stat = "identity") +  
  xlab("Time between pest and predator arrivals") +
  ylab("Nb. of occurences") +
  ggtitle("High proportion = 90% \nAgregation = 5, Year = 5, inf.rate = 4, nb.init = 10")


multiplot(plot1, plot2, cols=2)
```

## crop loss

```{r plot crop.loss landscape}
# non-normalisé VS normalisé (par le stock total de crop patches)
plot1 <- data.end.season.mean %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  # filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(year == 5) %>% 
  # plot
  ggplot() +
  geom_point(mapping = aes(x = proportion, y = mean.lsc.tot.crop.loss)) +
  scale_x_continuous(name = expression("Proportion"), 
                     breaks = seq(0,90,10),
                     labels = as.character(seq(0,90,10)),
                     limits = c(0, 90)) + # les ticks qui nous intéressent
  ylab("Total crop loss (mean)") +
  ggtitle("Total crop-loss for the whole landscape \nAgregation = 5, Year = 5, nb. init. = 10")

plot2 <- data.end.season.mean %>% 
  # normalisation crop-loss selon le nb. de crops
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  mutate(norm.mean.lsc.tot.crop.loss = mean.lsc.tot.crop.loss/stock.crops) %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  #filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(year == 5) %>% 
  # plot
  ggplot() +
  geom_point(mapping = aes(x = proportion, y = norm.mean.lsc.tot.crop.loss)) +
  scale_x_continuous(name = expression("Proportion"), 
                     breaks = seq(0,90,10),
                     labels = as.character(seq(0,90,10)),
                     limits = c(0, 90)) + # les ticks qui nous intéressent
  ylab("crop-loss per crop patch") +
  ggtitle("Total crop-loss (landscape) / total nb. of crop patches \nAgregation = 5, Year = 5, nb. init. = 10")

multiplot(plot1, plot2, cols=2)
```

## crop-loss VS nb. of adults at the beginning of the season

```{r plot crop.loss landscape VS nb. beginnning season}
data.end.season.mean %>% 
  select(- lsc.tot.crop.loss) %>%
  distinct() %>% 
  # normalisation crop-loss selon le nb. de crops
  mutate(stock.crops = 1089 - floor(1089*proportion/100)) %>% 
  mutate(norm.mean.lsc.tot.crop.loss = mean.lsc.tot.crop.loss/stock.crops) %>% 
  ungroup() %>% 
  mutate(proportion = factor(proportion)) %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  #filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(year == 5) %>% 
  # plot
  ggplot() +
  geom_point(mapping = aes(x = proportion, y = norm.mean.lsc.tot.crop.loss, colour="norm. crop loss (landscape)")) +
  geom_line(mapping = aes(x = proportion, y = norm.mean.lsc.tot.crop.loss, colour="norm. crop loss (landscape)", group = 1)) +
  geom_point(data = data.dyn.mean %>% 
               select(infection.rate, proportion, agregation, nb.init, year, tick, mean.adults) %>% 
               # inf.rate = 4
               filter(infection.rate == 4) %>% 
               #filter
               filter(agregation == 5) %>% 
               filter(nb.init == 10) %>% 
               filter(year == 5) %>% 
               filter(tick == 721),
             mapping = aes(x = proportion, y = mean.adults * 0.25 / max(mean.adults), colour="Nb. adults at t0")) +
  # geom_segment(data = data.dyn.mean %>% 
  #                select(infection.rate, proportion, agregation, nb.init, year, tick, mean.adults) %>% 
  #                # inf.rate = 4
  #                filter(infection.rate == 4) %>% 
  #                #filter
  #                filter(agregation == 5) %>% 
  #                filter(nb.init == 10) %>% 
  #                filter(year == 5) %>% 
  #                filter(tick == 721),
  #              aes(x = proportion, y = 0, xend = proportion, yend = mean.adults * 0.25 / max(mean.adults))) +
  xlab("Proportion") +
  scale_y_continuous(name = expression("crop-loss per crop patch"), #left axis
                      sec.axis = sec_axis(~ . * 150 / 0.25 , name = "Nb. of pred. adults")) +
  ggtitle("Total crop-loss (landscape) / total nb. of crop patches \nAgregation = 5, Year = 5, nb. init. = 10")
```

## distribution of crop loss values

```{r plot distribution of crop.loss values for crop patches}
data.spatial.mean %>% 
  # inf.rate = 4
  filter(infection.rate == 4) %>% 
  #filter
  filter(agregation == 5) %>% 
  filter(nb.init == 10) %>% 
  filter(year == 5) %>% 
  ggplot() +
  geom_boxplot(mapping = aes(x = factor(proportion), y = mean.tot.crop.loss)) +
  xlab("Proportion") +
  ylab("distribution of crop-loss values") +
  ggtitle("Distribution of crop-loss values for patches at the end of the season \nAgregation = 5, Year = 5, nb.init = 10")
```